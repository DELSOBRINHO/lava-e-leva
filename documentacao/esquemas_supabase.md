
# Esquemas do Banco de Dados - Supabase

Este documento contém os esquemas SQL para as tabelas utilizadas no banco de dados PostgreSQL do Supabase para o projeto Lava & Leva.

## Habilitar a extensão UUID

Antes de criar as tabelas, certifique-se de que a extensão `uuid-ossp` está habilitada no seu banco de dados Supabase para gerar UUIDs. Você pode rodar isso no SQL Editor do seu projeto Supabase.

```sql
create extension if not exists "uuid-ossp" with schema extensions;
```

---

## Tabela: `partners`

Esta tabela armazena as informações sobre as lavanderias parceiras.

### Estrutura SQL

```sql
-- Use `text` para o ID para corresponder aos MOCK_PARTNERS (ex: 'p1')
-- Se você usar IDs numéricos, mude para `bigint GENERATED BY DEFAULT AS IDENTITY`
CREATE TABLE public.partners (
  id text PRIMARY KEY,
  created_at timestamp with time zone DEFAULT now() NOT NULL,
  name text NOT NULL,
  rating numeric(2, 1) NOT NULL CHECK (rating >= 0 AND rating <= 5),
  delivery_time text NOT NULL,
  image_url text
);

-- Ativar Row Level Security (RLS)
ALTER TABLE public.partners ENABLE ROW LEVEL SECURITY;

-- Política de acesso: permitir que todos os usuários (autenticados ou não) leiam os dados dos parceiros.
CREATE POLICY "Allow public read access to partners"
ON public.partners
FOR SELECT
USING (true);
```

---

## Tabela: `orders`

Registra cada pedido feito na plataforma.

### Estrutura SQL

```sql
CREATE TABLE public.orders (
  id uuid DEFAULT extensions.uuid_generate_v4() PRIMARY KEY,
  user_id uuid REFERENCES auth.users(id) NOT NULL,
  partner_id text REFERENCES public.partners(id) NOT NULL,
  total numeric(10, 2) NOT NULL,
  status text NOT NULL,
  created_at timestamp with time zone DEFAULT now() NOT NULL
);

-- Ativar RLS
ALTER TABLE public.orders ENABLE ROW LEVEL SECURITY;

-- Política de acesso: permitir que usuários criem pedidos para si mesmos.
CREATE POLICY "Allow users to create their own orders"
ON public.orders
FOR INSERT
WITH CHECK (auth.uid() = user_id);

-- Política de acesso: permitir que usuários leiam apenas seus próprios pedidos.
CREATE POLICY "Allow users to read their own orders"
ON public.orders
FOR SELECT
USING (auth.uid() = user_id);

-- Política de acesso: permitir que usuários atualizem o status de seus próprios pedidos.
CREATE POLICY "Allow users to update their own orders"
ON public.orders
FOR UPDATE
USING (auth.uid() = user_id);
```

---

## Tabela: `order_items`

Tabela de junção que detalha os itens e quantidades de cada pedido.

### Estrutura SQL

```sql
CREATE TABLE public.order_items (
  id uuid DEFAULT extensions.uuid_generate_v4() PRIMARY KEY,
  order_id uuid REFERENCES public.orders(id) ON DELETE CASCADE NOT NULL,
  item_id text NOT NULL, -- Referencia o ID do item em `constants.tsx`
  quantity integer NOT NULL CHECK (quantity > 0),
  price_at_time numeric(10, 2) NOT NULL -- Preço do item no momento do pedido
);

-- Ativar RLS
ALTER TABLE public.order_items ENABLE ROW LEVEL SECURITY;

-- Política de acesso: permitir que usuários criem itens para seus pedidos.
-- A verificação é feita na tabela `orders` para garantir que o usuário é o dono do pedido.
CREATE POLICY "Allow users to create order_items for their orders"
ON public.order_items
FOR INSERT
WITH CHECK (
  EXISTS (
    SELECT 1 FROM orders WHERE id = order_id AND user_id = auth.uid()
  )
);

-- Política de acesso: permitir que usuários leiam os itens de seus próprios pedidos.
CREATE POLICY "Allow users to read order_items for their own orders"
ON public.order_items
FOR SELECT
USING (
  EXISTS (
    SELECT 1 FROM orders WHERE id = order_id AND user_id = auth.uid()
  )
);
```
